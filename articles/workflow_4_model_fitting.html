<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>IASDT modelling workflow — 4. Model fitting • IASDT.R</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="IASDT modelling workflow — 4. Model fitting">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">IASDT.R</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.07</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-file-code-o"></span> Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-modelling-workflow" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-book"></span> Modelling workflow</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-modelling-workflow">
<li><a class="dropdown-item" href="../articles/workflow_1_overview.html">Overview</a></li>
    <li><a class="dropdown-item" href="../articles/workflow_2_abiotic_data.html">Processing abiotic data</a></li>
    <li><a class="dropdown-item" href="../articles/workflow_3_biotic_data.html">Processing biotic data</a></li>
    <li><a class="dropdown-item" href="../articles/workflow_4_model_fitting.html">Model fitting</a></li>
    <li><a class="dropdown-item" href="../articles/workflow_5_model_postprocess.html">Model post-processing</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BioDT/IASDT.R/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="workflow_4_model_fitting_files/kePrint-0.0.1/kePrint.js"></script><link href="workflow_4_model_fitting_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>IASDT modelling workflow — 4. Model fitting</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BioDT/IASDT.R/blob/main/vignettes/workflow_4_model_fitting.Rmd" class="external-link"><code>vignettes/workflow_4_model_fitting.Rmd</code></a></small>
      <div class="d-none name"><code>workflow_4_model_fitting.Rmd</code></div>
    </div>

    
    
<script>
function toggleScript(id) {
  var content = document.getElementById(id);
  if (content.style.display === "none") {
    content.style.display = "block";
  } else {
    content.style.display = "none";
  }
}
</script><style>
/* Styles for the container div that holds the code block */
.ShortBlock {
  width: calc(100% - 40px);    /* Sets the width to 100% of the parent minus 40px to account for the left margin, ensuring it fits within the parent container */
  max-height: 400px;           /* Limits the maximum height to 400px; if content exceeds this, a vertical scrollbar will appear due to overflow-y */
  overflow-y: auto;            /* Enables a vertical scrollbar when content height exceeds max-height (400px), hides it when not needed */
  overflow-x: auto;            /* Enables a horizontal scrollbar when content width exceeds the div's width, hides it when not needed */
  margin-left: 40px;           /* Shifts the entire div (box and scrollbar) 40px to the right from the left edge of its parent, creating indentation */
  color: red;                  /* Sets the text color inside the div to red, applied to the <pre><code> content */
  display: block;              /* Ensures the div behaves as a block-level element, taking full width and stacking vertically */
  box-sizing: border-box;      /* Includes padding and border in the width calculation, preventing overflow beyond the calculated width */
  background-color: #f0f0f0;   /* Adds a light gray background for debugging, visually highlighting the div's area to check indentation */
  position: relative;          /* Sets the div's positioning context to relative, allowing absolute positioning of pseudo-elements (like ::before) within it */
  padding: 10px;               /* Adds 10px padding on all sides (top, right, bottom, left) for internal spacing between the div's edges and content */
}

/* Styles for the <pre> element inside .ShortBlock, which contains the code */
.ShortBlock pre {
  white-space: pre;            /* Preserves whitespace and prevents text wrapping, ensuring long lines extend horizontally as written */
  margin: 0;                   /* Removes default margins of the <pre> element to align it flush with the div's padded edges */
  width: max-content;          /* Sets the width to the natural width of the content (e.g., the longest line), enabling horizontal overflow if wider than the div */
  overflow: auto;              /* Adds scroll bars to the <pre> if its content overflows (though typically overridden by .ShortBlock's overflow-x/y) */
}

/* Customizes the appearance of the horizontal scrollbar for WebKit browsers (e.g., Chrome, Safari) */
.ShortBlock::-webkit-scrollbar {
  height: 10px;                /* Sets the height of the horizontal scrollbar to 10px, making it visible and sized consistently */
}

/* Creates a pseudo-element to simulate a top horizontal scrollbar area */
.ShortBlock::before {
  content: "";                 /* Defines an empty content for the pseudo-element, required to render it */
  display: block;              /* Makes the pseudo-element a block-level element, taking full width and stacking vertically */
  height: 10px;                /* Sets the height to 10px, matching the scrollbar size, creating a scrollable area at the top */
  width: 100%;                 /* Sets the width to 100% of the .ShortBlock div, aligning with its content area */
  position: absolute;          /* Positions the pseudo-element absolutely within the .ShortBlock (due to position: relative on parent) */
  top: 0;                      /* Aligns the pseudo-element to the top edge of the .ShortBlock div */
  left: 0;                     /* Aligns the pseudo-element to the left edge of the .ShortBlock div, starting at the padded edge */
  overflow-x: auto;            /* Enables horizontal scrolling for this pseudo-element, attempting to mirror the content's overflow (experimental) */
}

/* Styles for the button that toggles the collapsible code block */
.ShortBlockButton {
  color: red;                  /* Sets the button text color to red, matching the code block text */
  padding-left: 40px;          /* Adds 40px padding on the left, aligning the button text visually with the indented code block */
  border: none;                /* Removes the default border from the button for a clean look */
  background: none;            /* Removes the default background, making it transparent and minimal */
  cursor: pointer;             /* Changes the cursor to a pointer on hover, indicating the button is clickable */
}

ff {
  background-color: #def5ff;
  color: black;
  font-style: italic;
}

cc {
  background-color: #f0f7eb;
  color: black;
  font-style: italic;
}

.ll:visited {
  color: blue !important;
  text-decoration: none !important;
}

.ll:hover {
  text-decoration: underline !important;
  background-color: #d3f2aa !important;
  color: darkblue !important;
}

.ll:link, .ll:active {
  color: blue !important;
  text-decoration: none !important;
}

tab:before {
  content: "\00a0\00a0\00a0\00a0";
}

tab0:after {
  content: "\00a0\00a0";
}

table{
    width: 100% !important;
    margin-left: 50px !important;
}

table, th, td {
  padding: 1.8px !important;
  line-height: 1.3 !important;
}

.hr1 {
    width: 90%;
    margin-left: auto;
    margin-right: auto;
    border-top: 6px groove blue;
    margin: 30px auto;
    height: 4px;
    background-color: blue;
}

.hr2 {
    width: 50%;
    margin-left: auto;
    margin-right: auto;
    border-top: 6px groove orange;
    margin: 25px auto;
    height: 2px;
    background-color: orange;
}

br {
  display: block;
  margin: 4px 0;
}
</style>
<p><br><br></p>
<p>This article outlines the preparation of input data for model fitting
and the subsequent process of fitting these models on GPUs within the
<code>IASDT</code> workflow.</p>
<p><br><br></p>
<div class="section level2">
<h2 id="model-input-data">Model input data<a class="anchor" aria-label="anchor" href="#model-input-data"></a>
</h2>
<p>The primary function for preparing model-fitting data and
initialising models is <cc><code><a href="../reference/Mod_inputs.html">mod_prepare_HPC()</a></code></cc>. It
structures data for each habitat-specific model into distinct
directories (e.g., <ff>datasets/processed/model_fitting/HabX</ff>, where
<i>X</i> represents a
<a href="workflow_1_overview.html#models" class="ll">habitat type</a>).
This function orchestrates a suite of specialised sub-functions to
perform the following tasks:</p>
<p><br></p>
<ul>
<li>
<cc><code><a href="../reference/Mod_inputs.html">mod_prepare_data()</a></code></cc>: prepare input data for
modelling, with key arguments including:</li>
</ul>
<table class="table table table-condensed table-hover" style="font-size: 16px; margin-left: auto; margin-right: auto;"><tbody>
<tr>
<td style="text-align:left;padding-left: 4em;white-space: nowrap;" indentlevel="1">
<cc>hab_abb</cc><tab0></tab0>
</td>
<td style="text-align:left;">
abbreviation of a single habitat type to be modelled
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 4em;white-space: nowrap;" indentlevel="1">
<cc>directory_name</cc><tab0></tab0>
</td>
<td style="text-align:left;">
directory path for storing all model files
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 4em;white-space: nowrap;" indentlevel="1">
<cc>min_efforts_n_species</cc><tab0></tab0>
</td>
<td style="text-align:left;">
minimum number of vascular plant species per grid cell required for
inclusion in model fitting. This reflects the total count of vascular
plant species (including native species) recorded in GBIF across Europe,
as computed during the
<a href="workflow_2_abiotic_data.html#sampling-efforts" class="ll">sampling
effort preparation</a> step (<code><a href="../reference/Efforts_data.html">efforts_process()</a></code>). This
argument filters out grid cells with insufficient sampling effort
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 4em;white-space: nowrap;" indentlevel="1">
<cc>exclude_cultivated</cc><tab0></tab0>
</td>
<td style="text-align:left;">
whether to exclude countries with cultivated or casual observations for
each species
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 4em;white-space: nowrap;" indentlevel="1">
<cc>exclude_0_habitat</cc><tab0></tab0>
</td>
<td style="text-align:left;">
whether to exclude grid cells with zero
<a href="workflow_2_abiotic_data.html#corine-land-cover-habitat-data" class="ll">habitat
coverage</a> of the respective habitat type
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 4em;white-space: nowrap;" indentlevel="1">
<cc>n_pres_per_species</cc><tab0></tab0>
</td>
<td style="text-align:left;">
minimum number of presence grid cells required for a species to be
included in the models, calculated after excluding grid cells with low
sampling effort (<cc>min_efforts_n_species</cc>), zero habitat coverage
(<cc>exclude_0_habitat</cc>), and countries with cultivated or casual
observations (<cc>exclude_cultivated</cc>)
</td>
</tr>
</tbody></table>
<p><br><br></p>
<ul>
<li>
<code><a href="../reference/mod_CV_prepare.html">mod_CV_prepare()</a></code>: prepare and visualise options for
spatial-block cross-validation. In the <i>CV_Dist</i> strategy, block
size is governed by the <em>CV_n_grids</em> argument, whereas in the
<i>CV_Large</i> strategy, the study area is partitioned into larger
blocks based on the <em>CV_n_rows</em> and <em>CV_n_columns</em>
arguments.</li>
</ul>
<table class="table table table-condensed table-hover" style="font-size: 16px; margin-left: auto; margin-right: auto;"><tbody>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>CV_n_folds</cc><tab0></tab0>
</td>
<td style="text-align:left;">
number of cross-validation folds
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>CV_n_grids</cc><tab0></tab0>
</td>
<td style="text-align:left;">
number of grid cells in each directions for the <i>CV_Dist</i>
cross-validation strategy (default: 20, yielding 20 × 20 grid cell
blocks).
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>CV_n_rows / CV_n_columns</cc><tab0></tab0>
</td>
<td style="text-align:left;">
number of rows and columns defining in the <i>CV_Large</i>
cross-validation strategy, partitioning the study area into large blocks
(default: <em>CV_n_rows = CV_n_columns = 2</em>, resulting in four
blocks divided at median coordinates).
</td>
</tr>
</tbody></table>
<p><br><br></p>
<ul>
<li>
<code><a href="../reference/prepare_knots.html">prepare_knots()</a></code>: prepare and visualise knot locations
for Gaussian Predictive Process (GPP) models, as described by Tikhonov
<em>et al.</em>
(<a href="https://doi.org/10.1002/ecy.2929" target="_blank" class="external-link ll">2019</a>).</li>
</ul>
<table class="table table table-condensed table-hover" style="font-size: 16px; margin-left: auto; margin-right: auto;"><tbody>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>GPP</cc><tab0></tab0>
</td>
<td style="text-align:left;">
whether to incorporate spatial random effects using the Gaussian
Predictive Process (GPP)
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>GPP_dists</cc><tab0></tab0>
</td>
<td style="text-align:left;">
distance (in kilometres; controlled by the <code>min_distance</code>
argument of <code><a href="../reference/prepare_knots.html">prepare_knots()</a></code>) specifying both the spacing
between knots and the minimum distance between a knot and the nearest
sampling point
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>GPP_plot</cc><tab0></tab0>
</td>
<td style="text-align:left;">
whether to plot the coordinates of sampling units and knots
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>min_LF / max_LF</cc><tab0></tab0>
</td>
<td style="text-align:left;">
minimum and maximum number of latent factors to be include
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>alphapw</cc><tab0></tab0>
</td>
<td style="text-align:left;">
prior specification for the alpha parameter
</td>
</tr>
</tbody></table>
<p><br><br></p>
<ul>
<li>
<code><a href="../reference/Mod_SLURM.html">mod_SLURM()</a></code>: generate SLURM scripts to facilitate model
fitting on GPUs using the <code>Hmsc-HPC</code> extension.</li>
</ul>
<table class="table table table-condensed table-hover" style="font-size: 16px; margin-left: auto; margin-right: auto;"><tbody>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>job_name</cc><tab0></tab0>
</td>
<td style="text-align:left;">
name assigned to the SLURM job
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>ntasks</cc><tab0></tab0>
</td>
<td style="text-align:left;">
number of tasks to execute
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>cpus_per_task / gpus_per_node</cc><tab0></tab0>
</td>
<td style="text-align:left;">
Number of CPUs and GPUs allocated per node
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>memory_per_cpu</cc><tab0></tab0>
</td>
<td style="text-align:left;">
memory allocation per CPU
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>job_runtime</cc><tab0></tab0>
</td>
<td style="text-align:left;">
maximum duration for job execution
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>HPC_partition</cc><tab0></tab0>
</td>
<td style="text-align:left;">
name of the HPC partition
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>n_array_jobs</cc><tab0></tab0>
</td>
<td style="text-align:left;">
number of jobs within each SLURM script
</td>
</tr>
</tbody></table>
<p><br><br></p>
<p>Other arguments:</p>
<ul>
<li>selection of predictors:</li>
</ul>
<table class="table table table-condensed table-hover" style="font-size: 16px; margin-left: auto; margin-right: auto;"><tbody>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>bio_variables</cc><tab0></tab0>
</td>
<td style="text-align:left;">
names of
<a href="workflow_2_abiotic_data.html#chelsa-climate-data" class="ll">CHELSA</a>
variables to include in the model
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>quadratic_variables</cc><tab0></tab0>
</td>
<td style="text-align:left;">
names of variables for which quadratic terms are incorporated
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>efforts_as_predictor</cc><tab0></tab0>
</td>
<td style="text-align:left;">
whether to include the (log<sub>10</sub>-transformed)
<a href="workflow_2_abiotic_data.html#sampling-efforts" class="ll">sampling
effort</a> as a predictor
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>road_rail_as_predictor</cc><tab0></tab0>
</td>
<td style="text-align:left;">
whether to include the (log<sub>10</sub>-transformed)
<a href="workflow_2_abiotic_data.html#railways-and-roads-intensity" class="ll">summed
road and railway intensity</a> as a predictor
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>habitat_as_predictor</cc><tab0></tab0>
</td>
<td style="text-align:left;">
whether to include the (log<sub>10</sub>-transformed)
<a href="workflow_2_abiotic_data.html#corine-land-cover-habitat-data" class="ll">percentage
coverage of the respective habitat type</a> per grid cell as a predictor
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>river_as_predictor</cc><tab0></tab0>
</td>
<td style="text-align:left;">
whether to include the (log<sub>10</sub>-transformed) total
<a href="workflow_2_abiotic_data.html#river-length" class="ll">river
length</a> per grid cell as a predictor
</td>
</tr>
</tbody></table>
<p><br><br></p>
<ul>
<li>model fitting options</li>
</ul>
<table class="table table table-condensed table-hover" style="font-size: 16px; margin-left: auto; margin-right: auto;"><tbody>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>MCMC_n_chains</cc><tab0></tab0>
</td>
<td style="text-align:left;">
number of MCMC chains
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>MCMC_thin</cc><tab0></tab0>
</td>
<td style="text-align:left;">
thinning value(s) in MCMC sampling
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>MCMC_samples</cc><tab0></tab0>
</td>
<td style="text-align:left;">
number of MCMC samples per chain
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>MCMC_transient_factor</cc><tab0></tab0>
</td>
<td style="text-align:left;">
transient multiplication factor. The value of transient will equal the
multiplication of <cc>transientFactor</cc> and <cc>thin</cc>
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>MCMC_verbose</cc><tab0></tab0>
</td>
<td style="text-align:left;">
interval at which MCMC sampling progress is reported
</td>
</tr>
<tr>
<td style="text-align:left;padding-left: 2em;white-space: nowrap;" indentlevel="1">
<cc>precision</cc><tab0></tab0>
</td>
<td style="text-align:left;">
floating-point precision mode for Hmsc-HPC sampling
</td>
</tr>
</tbody></table>
<p><br><br></p>
<ul>
<li>
<cc>n_species_per_grid</cc>: minimum number of IAS per grid cell for
a grid cell to be included in the analysis</li>
<li>
<cc>model_country</cc>: fit the model for a specific country or
countries</li>
<li>whether or not to use phylogenetic trees: <cc>use_phylo_tree</cc>
and <cc>no_phylo_tree</cc>
</li>
<li>
<cc>path_Hmsc</cc>: directory path to <code>Hmsc-HPC</code>
extension installation</li>
<li>
<cc>SLURM_prepare</cc>: whether to prepare SLURM script for model
fitting on GPU via <code><a href="../reference/Mod_SLURM.html">mod_SLURM()</a></code>
</li>
</ul>
<hr class="hr1">
</div>
<div class="section level2">
<h2 id="model-fitting-on-gpus">Model fitting on GPUs<a class="anchor" aria-label="anchor" href="#model-fitting-on-gpus"></a>
</h2>
<p>Following the preparation of model input data and initialisation of
models, the subsequent phase involves fitting these models on GPUs. For
each habitat type, the <code><a href="../reference/Mod_inputs.html">mod_prepare_HPC()</a></code> function
produces:</p>
<ul>
<li>python commands (<ff>Commands2Fit.txt</ff>) for fitting model chains
across all model variants on GPUs, with each line corresponding to a
single chain.</li>
</ul>
<button onclick="toggleScript('scriptContentNS1')" class="ShortBlockButton">
»» Example model fitting commands
</button>
<div id="scriptContentNS1" class="ShortBlock" style="display: none;">
<pre><code class="bash">python3 -m hmsc.run_gibbs_sampler --input datasets/processed/model_fitting/Mod_Riv_Hab1/InitMod4HPC/InitMod_GPP120_Tree_samp1000_th200.rds --output datasets/processed/model_fitting/Mod_Riv_Hab1/Model_Fitting_HPC/GPP120_Tree_samp1000_th200_Chain1_post.rds --samples 1000 --transient 100000 --thin 200 --verbose 200 --chain 0 --fp 64 &gt;&amp; datasets/processed/model_fitting/Mod_Riv_Hab1/Model_Fitting_HPC/GPP120_Tree_samp1000_th200_Chain1_Progress.txt
python3 -m hmsc.run_gibbs_sampler --input datasets/processed/model_fitting/Mod_Riv_Hab1/InitMod4HPC/InitMod_GPP120_Tree_samp1000_th200.rds --output datasets/processed/model_fitting/Mod_Riv_Hab1/Model_Fitting_HPC/GPP120_Tree_samp1000_th200_Chain2_post.rds --samples 1000 --transient 100000 --thin 200 --verbose 200 --chain 1 --fp 64 &gt;&amp; datasets/processed/model_fitting/Mod_Riv_Hab1/Model_Fitting_HPC/GPP120_Tree_samp1000_th200_Chain2_Progress.txt</code></pre>
</div>
<p><br></p>
<ul>
<li>one or more SLURM script files (<ff>Bash_Fit.slurm</ff>) designed to
submit all model-fitting commands (<ff>Commands2Fit.txt</ff>) as batch
jobs on a high-performance computing (HPC) system.</li>
</ul>
<p><br></p>
<button onclick="toggleScript('scriptContentNS2')" class="ShortBlockButton">
»» Example SLURM script
</button>
<div id="scriptContentNS2" class="ShortBlock" style="display: none;">
<pre><code class="bash">#!/bin/bash

# -----------------------------------------------------------
# Job array configuration
# -----------------------------------------------------------
#SBATCH --job-name=Hab1
#SBATCH --ntasks=1
#SBATCH --output=datasets/processed/model_fitting/Mod_Riv_Hab1/Model_Fitting_HPC/JobsLog/%x-%A-%a.out
#SBATCH --error=datasets/processed/model_fitting/Mod_Riv_Hab1/Model_Fitting_HPC/JobsLog/%x-%A-%a.out
#SBATCH --account=project_465001588
#SBATCH --cpus-per-task=1
#SBATCH --gpus-per-node=1
#SBATCH --time=3-00:00:00
#SBATCH --partition=small-g
#SBATCH --array=1-30

# -----------------------------------------------------------
# Job info
# -----------------------------------------------------------
echo "Start time = $(date)"
echo "Submitting directory = "$SLURM_SUBMIT_DIR
echo "working directory = "$PWD
echo "Project name = "$SLURM_JOB_ACCOUNT
echo "Job id = "$SLURM_JOB_ID
echo "Job name = "$SLURM_JOB_NAME
echo "memory per CPU = "$SLURM_MEM_PER_CPU
echo "The GPU IDs of GPUs in the job allocation (if any) = "$SLURM_JOB_GPUS
echo "Node running the job script = "$SLURMD_NODENAME
echo "Process ID of the process started for the task = "$SLURM_TASK_PID
echo "Dependency = "$SLURM_JOB_DEPENDENCY
echo "Number of nodes assigned to a job = "$SLURM_NNODES
echo "Number of tasks requested by the job = "$SLURM_NTASKS
echo "Number of cpus per task = "$SLURM_CPUS_PER_TASK
echo "Number of tasks in the array = "$SLURM_ARRAY_TASK_COUNT
echo "Array's maximum ID (index) number = "$SLURM_ARRAY_TASK_MIN
echo "Array's minimum ID (index) number = "$SLURM_ARRAY_TASK_MAX

# -----------------------------------------------------------
# File contains bash commands for model fitting
# -----------------------------------------------------------
File=datasets/processed/model_fitting/Mod_Riv_Hab1/Commands2Fit.txt

# -----------------------------------------------------------
# Loading Hmsc-HPC
# -----------------------------------------------------------
source /pfs/lustrep4/scratch/project_465001857/elgabbas/Hmsc_simplify_io/setup-env.sh

# -----------------------------------------------------------
# Check GPU
# -----------------------------------------------------------
export TF_CPP_MIN_LOG_LEVEL=3
PythonCheckGPU=references/LUMI_Check_GPU.py

# -----------------------------------------------------------
# Some checking
# -----------------------------------------------------------
Path_Python=$(which python3)
echo -e "Some Checking:\n  &gt;&gt;  Working directory: $PWD\n  &gt;&gt;  Python path:       $Path_Python\n  &gt;&gt;  Checking GPU:      $(python3 $PythonCheckGPU)\n"

# -----------------------------------------------------------
# Run array job
# -----------------------------------------------------------
head -n $SLURM_ARRAY_TASK_ID $File | tail -n 1 | bash

echo "End of program at `date`"


# |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# This script was created on: 2025-02-13 19:43 CET
# |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</code></pre>
</div>
<p><br><br></p>
<p>Batch jobs for model fitting can be submitted using the
<code>sbatch</code> command, for example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">sbatch</span> datasets/processed/model_fitting/Hab1/Bash_Fit.slurm</span></code></pre></div>
<hr class="hr1">
<p><span style="font-size: 1.2em; line-height: 0.8;"> <b>Previous
articles:</b><br><tab>↠<tab><a href="workflow_1_overview.html" class="ll">1.
Overview</a><br><tab>↠<tab><a href="workflow_2_abiotic_data.html" class="ll">2.
Processing abiotic data</a><br><tab>↠<tab><a href="workflow_3_biotic_data.html" class="ll">3.
Processing biotic data</a><br><b>Next articles:</b><br><tab>↠<tab><a href="workflow_5_model_postprocess.html" class="ll">5.
Model post-processing</a><br></tab></tab></tab></tab></tab></tab></tab></tab></span></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://elgabbas.netlify.app/" class="external-link">Ahmed El-Gabbas</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
